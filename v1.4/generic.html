

<!DOCTYPE html>
<html class="no-js" lang="en">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title> Deploying Scylla on a Kubernetes Cluster | Scylla Docs
    </title>
    <meta name="description" content="Scylla is an Apache Cassandra-compatible NoSQL data store that can handle 1 million transactions per second on a single server." />
    <link
      rel="icon"
      href="_static/img/favicon.ico"
      type="image/x-icon"
    />
    <link
      rel="icon"
      href="_static/img/favicon-32x32.png"
      sizes="32x32"
    />
    <link
      rel="icon"
      href="_static/img/favicon-228x228.png"
      sizes="192x192"
    />
    <link
      rel="apple-touch-icon"
      href="_static/img/favicon-228x228.png"
    />
    <meta
      name="msapplication-TileImage"
      href="_static/img/favicon-228x228.png"
    />
    <link rel="canonical" href="https://docs.scylladb.com/" />
    <link rel="author" href="mailto:info@scylladb.com" />
  <!-- connect to domain of font files -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

  <!-- optionally increase loading priority -->
  <link
    rel="preload"
    as="style"
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap"
  />

  <!-- async CSS -->
  <link
    rel="stylesheet"
    media="print"
    onload="this.onload=null;this.removeAttribute('media');"
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap"
  />

  <!-- no-JS fallback -->
  <noscript>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400&display=swap"
    />
  </noscript>
  <link
    rel="stylesheet"
    href="_static/css/main.css"
    type="text/css"
  />
  <link
    rel="stylesheet"
    href="_static/pygments.css"
    type="text/css"
  /> <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />

  <script
    type="text/javascript"
    id="documentation_options"
    data-url_root="./"
    src="_static/documentation_options.js"
  ></script>
  <script
    type="text/javascript"
    src="_static/js/runtime.bundle.js"
  ></script>
  <script
    type="text/javascript"
    src="_static/js/main.bundle.js"
  ></script> <script src="_static/underscore.js"></script> <script src="_static/doctools.js"></script> <script src="_static/language_data.js"></script> <script src="_static/clipboard.min.js"></script> <script src="_static/copybutton.js"></script>

    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-T8P2JP");
    </script>
    <!-- End Google Tag Manager -->
    <!-- Marketo -->
    <script type="text/javascript">
      (function () {
        var didInit = false;
        function initMunchkin() {
          if (didInit === false) {
            didInit = true;
            Munchkin.init("791-QBF-350");
          }
        }
        var s = document.createElement("script");
        s.type = "text/javascript";
        s.async = true;
        s.src = "//munchkin.marketo.net/munchkin.js";
        s.onreadystatechange = function () {
          if (this.readyState == "complete" || this.readyState == "loaded") {
            initMunchkin();
          }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName("head")[0].appendChild(s);
      })();
    </script>
    <!-- End Marketo -->
    <!-- Expertrec -->
    <script>
      var id = "e2077224-9ccf-11e9-a0c9-0242ac130002";
      var ci_search = document.createElement("script");
      ci_search.type = "text/javascript";
      ci_search.async = true;
      ci_search.src = "https://cse.expertrec.com/api/js/ci_common.js?id=" + id;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(ci_search, s);
    </script>
    <!-- End Expertrec -->

    <!-- Font Awesome -->
    <script
      src="https://kit.fontawesome.com/b1870adf6a.js"
      crossorigin="anonymous"
    ></script>
    <!-- End Font Awesome -->
  </head>
  
  <body>
     <header class="header">
  <div class="header-logo">
    <a class="header-logo__img" href="https://scylladb.com/">
      <img
        src="_static/img/logo-scylla-docs.svg"
        alt="Scylla Documentation Logo"
      />
    </a>
    <span class="header-logo__bar"></span>
    <a class="header-logo__text" href="https://docs.scylladb.com/">
      Documentation
    </a>
  </div>
  <div class="header-navigation">
    <ul
      class="dropdown menu scylla-dropdown scylla-dropdown--header"
      data-dropdown-menu
    >
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Server <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a href="https://docs.scylladb.com/"
              ><i class="scylla-icon scylla-icon--about-us"></i>Scylla Open
              Source</a
            >
          </li>
          <li>
            <a href="https://docs.scylladb.com/"
              ><i class="scylla-icon scylla-icon--enterprise"></i>Scylla
              Enterprise</a
            >
          </li>
          <li>
            <a
              href="https://scylla.docs.scylladb.com/master/alternator/alternator.html"
            >
              <i class="scylla-icon scylla-icon--overview"></i>Scylla
              Alternator</a
            >
          </li>
        </ul>
      </li>
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Cloud <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a href="https://cloud.scylladb.com/">
              <i class="scylla-icon scylla-icon--cloud"></i>Scylla Cloud</a
            >
          </li>
          <li>
            <a href="https://docs.scylladb.com/scylla-cloud/">
              <i class="scylla-icon scylla-icon--cloud-docs"></i>Scylla Cloud
              Docs</a
            >
          </li>
        </ul>
      </li>
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Tools <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a href="https://manager.docs.scylladb.com/">
              <i class="scylla-icon scylla-icon--manager"></i>Scylla Manager</a
            >
          </li>
          <li>
            <a href="https://monitoring.docs.scylladb.com/">
              <i class="scylla-icon scylla-icon--monitoring"></i>Scylla
              Monitoring Stack</a
            >
          </li>
          <li>
            <a href="https://operator.docs.scylladb.com/">
              <i class="scylla-icon scylla-icon--operator"></i>Scylla Operator
            </a>
          </li>
        </ul>
      </li>
      <li class="scylla-dropdown__item">
        <a href="#" class="scylla-dropdown__title"
          >Drivers <i class="chevron scylla-icon scylla-icon--triangle-down"></i
        ></a>
        <ul class="menu scylla-dropdown__content">
          <li>
            <a
              href="https://docs.scylladb.com/using-scylla/drivers/cql-drivers/"
            >
              <i class="scylla-icon scylla-icon--nsql-guides"></i>CQL Drivers
            </a>
          </li>
          <li>
            <a
              href="https://docs.scylladb.com/using-scylla/drivers/dynamo-drivers/"
            >
              <i class="scylla-icon scylla-icon--overview"></i>DynamoDB Drivers
            </a>
          </li>
        </ul>
      </li>
    </ul>
    <div class="header-button">
      <a href="https://www.scylladb.com/download/" class="button">Download</a>
    </div>
  </div>
  <div class="header-search-box">
    <div class="search-box">
      <ci-search></ci-search>
    </div>
  </div>
  <div class="side-nav-toggle" data-toggle="side-nav">
  <div class="side-nav-toggle__button">
    <img src="_static/img/menu.svg" alt="Menu" />
  </div>
</div>
</header>
    <section class="layout ">
      <div class="content large-order-2">
         

        <div class="pre-content">
          <div class="pre-content__left"><div class="breadcrumbs">
  <span class="bread__item">
    <a
      href="index.html"
      class="bread__highlight"
    >
      <i class="fas fa-home"></i> Scylla Operator</a
    ></span
  >
  
  <span class="bread__item bread__item--last">Deploying Scylla on a Kubernetes Cluster</span>
</div></div>
          <div class="pre-content__right"><ul
  class="dropdown menu scylla-dropdown scylla-dropdown--contribute"
  data-dropdown-menu
>
  <li class="scylla-dropdown__item">
    <a class="scylla-dropdown__title" href="#">
      <div class="scylla-dropdown__title--body">
        <i class="icon fa fa-github" aria-hidden="true"></i>
        Contribute
      </div>
      <i class="chevron scylla-icon scylla-icon--chevron-right"></i>
    </a>
    <ul class="menu scylla-dropdown__content">
      <li>
        <a
          href="https://github.com/scylladb/scylla-operator/issues/new?title=Issue in page Deploying Scylla on a Kubernetes Cluster&&body=I%20would%20like%20to%20report%20an%20issue%20in%20page%20https://operator.docs.scylladb.com/v1.4/generic%0A%0A%23%23%23%20Problem%0A%0A%23%23%23%20%20Suggest%20a%20fix"
          target="_blank"
          >Report a doc issue
          <i class="icon fa fa-external-link" aria-hidden="true"></i
        ></a>
      </li>
      
      <li>
             
        <a
          href="https://github.com/scylladb/scylla-operator/edit/v1.4/docs/source/generic.md"
          target="_blank"
          >Edit this page
          <i class="icon fa fa-external-link" aria-hidden="true"></i
        ></a>
      </li>
      
      <li>
        <a href="https://docs.scylladb.com/contribute/" target="_blank"
          >Learn how to contribute
          <i class="icon fa fa-external-link" aria-hidden="true"></i
        ></a>
      </li>
    </ul>
  </li>
</ul></div>
        </div>
         <div class="section" id="deploying-scylla-on-a-kubernetes-cluster">
<h1>Deploying Scylla on a Kubernetes Cluster<a class="headerlink" href="#deploying-scylla-on-a-kubernetes-cluster" title="Permalink to this headline">¶</a></h1>
<p>This is a guide to deploy a Scylla Cluster in a generic Kubernetes environment, meaning that Scylla will not be deployed with the ideal performance.
Scylla performs the best when it has fast disks and direct access to the cpu.
This requires some extra setup, which is platform-specific.
For specific configuration and setup, check for details about your particular environment:</p>
<ul class="simple">
<li><p><a class="reference internal" href="gke.html"><span class="doc">GKE</span></a></p></li>
</ul>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>A Kubernetes cluster</p></li>
<li><p>A <a class="reference external" href="https://kubernetes.io/docs/concepts/storage/storage-classes/">Storage Class</a> to provision <a class="reference external" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">PersistentVolumes</a>.</p></li>
<li><p>Helm 3 installed, Go to the <a class="reference external" href="https://docs.helm.sh/using_helm/#installing-helm">helm docs</a> if you need to install it.
Make sure that you enable the <a class="reference external" href="https://github.com/helm/charts#how-do-i-enable-the-stable-repository-for-helm-3">stable repository</a></p></li>
</ul>
</div>
<div class="section" id="running-locally">
<h2>Running locally<a class="headerlink" href="#running-locally" title="Permalink to this headline">¶</a></h2>
<p>Running kubernetes locally is a daunting and error prone task.
Fortunately there are ways to make life easier and <a class="reference external" href="https://minikube.sigs.k8s.io/docs/">Minikube</a> makes it a breeze.</p>
<p>We need to give minikube a little bit more resources than default so start minikube like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">minikube start --cpus=6</span>
</pre></div>
</div>
<p>Then make kubectl aware of this local installation like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">eval $(minikube docker-env)</span>
</pre></div>
</div>
</div>
<div class="section" id="deploy-cert-manager">
<h2>Deploy Cert Manager<a class="headerlink" href="#deploy-cert-manager" title="Permalink to this headline">¶</a></h2>
<p>First deploy Cert Manager, you can either follow <a class="reference external" href="https://cert-manager.io/docs/installation/kubernetes/">upsteam instructions</a> or use following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl apply -f examples/common/cert-manager.yaml</span>
</pre></div>
</div>
<p>This will install Cert Manager to provision a self-signed certificate.</p>
<p>Once it’s deployed, wait until Cert Manager is ready:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl wait --for condition=established crd/certificates.cert-manager.io crd/issuers.cert-manager.io</span>
<span class="go">kubectl -n cert-manager rollout status deployment.apps/cert-manager-webhook</span>
</pre></div>
</div>
</div>
<div class="section" id="deploy-scylla-operator">
<h2>Deploy Scylla Operator<a class="headerlink" href="#deploy-scylla-operator" title="Permalink to this headline">¶</a></h2>
<p>Deploy the Scylla Operator using the following commands:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl apply -f examples/common/operator.yaml</span>
</pre></div>
</div>
<p>This will install the operator in namespace <code class="docutils literal notranslate"><span class="pre">scylla-operator</span></code>.
Wait until it’s ready:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl wait --for condition=established crd/scyllaclusters.scylla.scylladb.com</span>
<span class="go">kubectl -n scylla-operator rollout status deployment.apps/scylla-operator</span>
</pre></div>
</div>
<p>If you want to check the logs of the operator you can do so with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla-operator logs deployment.apps/scylla-operator</span>
</pre></div>
</div>
</div>
<div class="section" id="create-and-initialize-a-scylla-cluster">
<h2>Create and Initialize a Scylla Cluster<a class="headerlink" href="#create-and-initialize-a-scylla-cluster" title="Permalink to this headline">¶</a></h2>
<p>Now that the operator is running, we can create an instance of a Scylla cluster by creating an instance of the <code class="docutils literal notranslate"><span class="pre">clusters.scylla.scylladb.com</span></code> resource.
Some of that resource’s values are configurable, so feel free to browse <code class="docutils literal notranslate"><span class="pre">cluster.yaml</span></code> and tweak the settings to your liking.
Full details for all the configuration options can be found in the <a class="reference internal" href="scylla_cluster_crd.html"><span class="doc">Scylla Cluster CRD documentation</span></a>.</p>
<p>When you are ready to create a Scylla cluster, simply run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl create -f examples/generic/cluster.yaml</span>
</pre></div>
</div>
<p>We can verify that a Kubernetes object has been created that represents our new Scylla cluster with the command below.
This is important because it shows that  has successfully extended Kubernetes to make Scylla clusters a first class citizen in the Kubernetes cloud-native environment.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla get ScyllaCluster</span>
</pre></div>
</div>
<p>Checking the pods that are created is as easy as:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla get pods</span>
</pre></div>
</div>
<p>The output should be something like:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">NAME                                    READY   STATUS    RESTARTS   AGE</span>
<span class="go">simple-cluster-us-east-1-us-east-1a-0   2/2     Running   0          9m49s</span>
<span class="go">simple-cluster-us-east-1-us-east-1a-1   2/2     Running   0          7m43s</span>
<span class="go">simple-cluster-us-east-1-us-east-1a-2   2/2     Running   0          6m46s</span>
</pre></div>
</div>
<p>It is important to note that the operator creates these instances according to a pattern.
This pattern is as follows: <code class="docutils literal notranslate"><span class="pre">CLUSTER_NAME-DATACENTER_NAME-RACK_NAME-INSTANCE_NUMBER</span></code> as specified in <code class="docutils literal notranslate"><span class="pre">cluster.yaml</span></code>.</p>
<p>In the above example we have the following properties:</p>
<ul class="simple">
<li><p>CLUSTER_NAME: <code class="docutils literal notranslate"><span class="pre">simple-cluster</span></code></p></li>
<li><p>DATACENTER_NAME: <code class="docutils literal notranslate"><span class="pre">us-east-1</span></code></p></li>
<li><p>RACK_NAME: <code class="docutils literal notranslate"><span class="pre">us-east-1a</span></code></p></li>
<li><p>INSTANCE_NUMBER: An automatically generated number attached to the pod name.</p></li>
</ul>
<p>We picked the names to resemble something you can find in a cloud service but this is inconsequential, they can be set to anything you want.</p>
<p>To check if all the desired members are running, you should see the same number of entries from the following command as the number of members that was specified in <code class="docutils literal notranslate"><span class="pre">cluster.yaml</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla get pod -l app=scylla</span>
</pre></div>
</div>
<p>You can also track the state of a Scylla cluster from its status. To check the current status of a Cluster, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla describe ScyllaCluster simple-cluster</span>
</pre></div>
</div>
<p>Checking the logs of the running scylla instances can be done like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla logs simple-cluster-us-east-1-us-east-1a-0 scylla</span>
</pre></div>
</div>
<div class="section" id="configure-host-networking">
<h3>Configure host networking<a class="headerlink" href="#configure-host-networking" title="Permalink to this headline">¶</a></h3>
<p>To squeeze the most out of your deployment it is sometimes necessary to employ <a class="reference external" href="https://kubernetes.io/docs/concepts/services-networking/">host networking</a>.
To enable this the CRD allows for specifying a <code class="docutils literal notranslate"><span class="pre">network</span></code> parameter as such:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4.0.0</span>
  <span class="l l-Scalar l-Scalar-Plain">agentVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2.0.2</span>
  <span class="l l-Scalar l-Scalar-Plain">cpuset</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">network</span><span class="p p-Indicator">:</span>
    <span class="nt">hostNetworking</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>This will result in hosts network to be used for the Scylla Stateful Set deployment.</p>
</div>
<div class="section" id="configure-container-kernel-parameters">
<h3>Configure container kernel parameters<a class="headerlink" href="#configure-container-kernel-parameters" title="Permalink to this headline">¶</a></h3>
<p>Sometimes it is necessary to run the container with different kernel parameters.
In order to support this, the Scylla Operator defines a cluster property <code class="docutils literal notranslate"><span class="pre">sysctls</span></code> that is a list of the desired key-value pairs to set.</p>
<p><em><strong>For example</strong></em>: To increase the number events available for asynchronous IO processing in the Linux kernel to N set sysctls to<code class="docutils literal notranslate"><span class="pre">fs.aio-max-nr=N</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">racks</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rack-name</span>
    <span class="nt">scyllaConfig</span><span class="p">:</span> <span class="s">&quot;scylla-config&quot;</span>
    <span class="nt">scyllaAgentConfig</span><span class="p">:</span> <span class="s">&quot;scylla-agent-config&quot;</span>
    <span class="nt">sysctls</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;fs.aio-max-nr=2097152&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="deploying-alternator">
<h3>Deploying Alternator<a class="headerlink" href="#deploying-alternator" title="Permalink to this headline">¶</a></h3>
<p>The operator is also capable of deploying <a class="reference external" href="https://www.scylladb.com/alternator/">Alternator</a> instead of the regular Scylla.
This requires a small change in the cluster definition.
Change the <code class="docutils literal notranslate"><span class="pre">cluster.yaml</span></code> file from this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spec</span><span class="p">:</span>
  <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4.0.0</span>
  <span class="nt">agentVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2.0.2</span>
  <span class="nt">developerMode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">datacenter</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">us-east-1</span>
</pre></div>
</div>
<p>to this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spec</span><span class="p">:</span>
  <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4.0.0</span>
  <span class="nt">alternator</span><span class="p">:</span>
    <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8000</span>
    <span class="nt">writeIsolation</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">only_rmw_uses_lwt</span>
  <span class="nt">agentVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2.0.2</span>
  <span class="nt">developerMode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">datacenter</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">us-east-1</span>
</pre></div>
</div>
<p>You can specify whichever port you want.</p>
<p>You must provide desired write isolation, supported values are: “always”, “forbid_rmw”, “only_rmw_uses_lwt”.
Difference between those isolation levels can be found in Scylla Alternator documentation.</p>
<p>Once this is done the regular CQL ports will no longer be available, the cluster is a pure Alienator cluster.</p>
</div>
</div>
<div class="section" id="accessing-the-database">
<h2>Accessing the Database<a class="headerlink" href="#accessing-the-database" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>From kubectl:</p></li>
</ul>
<p>To get a cqlsh shell in your new Cluster:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl exec -n scylla -it simple-cluster-us-east-1-us-east-1a-0 -- cqlsh</span>
<span class="go">&gt; DESCRIBE KEYSPACES;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>From inside a Pod:</p></li>
</ul>
<p>When you create a new Cluster,  automatically creates a Service for the clients to use in order to access the Cluster.
The service’s name follows the convention <code class="docutils literal notranslate"><span class="pre">&lt;cluster-name&gt;-client</span></code>.
You can see this Service in your cluster by running:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla describe service simple-cluster-client</span>
</pre></div>
</div>
<p>Pods running inside the Kubernetes cluster can use this Service to connect to Scylla.
Here’s an example using the <a class="reference external" href="https://github.com/datastax/python-driver">Python Driver</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cassandra.cluster</span> <span class="kn">import</span> <span class="n">Cluster</span>

<span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="p">([</span><span class="s1">&#39;simple-cluster-client.scylla.svc&#39;</span><span class="p">])</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</pre></div>
</div>
<p>If you are running the Alternator you can access the API on the port you specified using plain http.</p>
</div>
<div class="section" id="configure-scylla">
<h2>Configure Scylla<a class="headerlink" href="#configure-scylla" title="Permalink to this headline">¶</a></h2>
<p>The operator can take a ConfigMap and apply it to the scylla.yaml configuration file.
This is done by adding a ConfigMap to Kubernetes and refering to this in the Rack specification.
The ConfigMap is just a file called <code class="docutils literal notranslate"><span class="pre">scylla.yaml</span></code> that has the properties you want to change in it.
The operator will take the default properties for the rest of the configuration.</p>
<ul class="simple">
<li><p>Create a ConfigMap the default name that the operator uses is <code class="docutils literal notranslate"><span class="pre">scylla-config</span></code>:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl create configmap scylla-config -n scylla --from-file=/path/to/scylla.yaml</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Wait for the mount to propagate and then restart the cluster:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl rollout restart -n scylla statefulset/simple-cluster-us-east-1-us-east-1a</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The new config should be applied automatically by the operator, check the logs to be sure.</p></li>
</ul>
<p>Configuring <code class="docutils literal notranslate"><span class="pre">cassandra-rackdc.properties</span></code> is done by adding the file to the same mount as <code class="docutils literal notranslate"><span class="pre">scylla.yaml</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl create configmap scylla-config -n scylla --from-file=/tmp/scylla.yaml --from-file=/tmp/cassandra-rackdc.properties -o yaml --dry-run | kubectl replace -f -</span>
</pre></div>
</div>
<p>The operator will then apply the overridable properties <code class="docutils literal notranslate"><span class="pre">prefer_local</span></code> and <code class="docutils literal notranslate"><span class="pre">dc_suffix</span></code> if they are available in the provided mounted file.</p>
</div>
<div class="section" id="configure-scylla-manager-agent">
<h2>Configure Scylla Manager Agent<a class="headerlink" href="#configure-scylla-manager-agent" title="Permalink to this headline">¶</a></h2>
<p>The operator creates a second container for each scylla instance that runs <a class="reference external" href="https://hub.docker.com/r/scylladb/scylla-manager-agent">Scylla Manager Agent</a>.
This container serves as a sidecar and it’s the main endpoint for interacting with Scylla API.
The Scylla Manager Agent can be configured with various things such as the security token used to allow access to Scylla API and storage providers for backups.</p>
<p>To configure the agent you just create a new secret called <em>scylla-agent-config-secret</em> and populate it with the contents in the <code class="docutils literal notranslate"><span class="pre">scylla-manager-agent.yaml</span></code> file like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl create secret -n scylla generic scylla-agent-config-secret --from-file scylla-manager-agent.yaml</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://docs.scylladb.com/operating-scylla/manager/2.0/agent-configuration-file/">Scylla Manager Agent configuration</a> for a complete reference of the Scylla Manager agent config file.</p>
<div class="section" id="scylla-manager-agent-auth-token">
<h3>Scylla Manager Agent auth token<a class="headerlink" href="#scylla-manager-agent-auth-token" title="Permalink to this headline">¶</a></h3>
<p>Operator provisions Agent auth token by copying value from user provided config secret or auto generates it if it’s empty.
To check which value is being used, decode content of <code class="docutils literal notranslate"><span class="pre">&lt;cluster-name&gt;-auth-token</span></code> secret.
To change it simply remove the secret. Operator will create a new one. To pick up the change in the cluster, initiate a rolling restart.</p>
</div>
</div>
<div class="section" id="set-up-monitoring">
<h2>Set up monitoring<a class="headerlink" href="#set-up-monitoring" title="Permalink to this headline">¶</a></h2>
<p>To set up monitoring using Prometheus and Grafana follow <a class="reference internal" href="monitoring.html"><span class="doc">this guide</span></a>.</p>
</div>
<div class="section" id="scale-up">
<h2>Scale Up<a class="headerlink" href="#scale-up" title="Permalink to this headline">¶</a></h2>
<p>The operator supports scale up of a rack as well as addition of new racks. To make the changes, you can use:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla edit ScyllaCluster simple-cluster</span>
</pre></div>
</div>
<ul class="simple">
<li><p>To scale up a rack, change the <code class="docutils literal notranslate"><span class="pre">Spec.Members</span></code> field of the rack to the desired value.</p></li>
<li><p>To add a new rack, append the <code class="docutils literal notranslate"><span class="pre">racks</span></code> list with a new rack. Remember to choose a different rack name for the new rack.</p></li>
<li><p>After editing and saving the yaml, check your cluster’s Status and Events for information on what’s happening:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla describe ScyllaCluster simple-cluster</span>
</pre></div>
</div>
</div>
<div class="section" id="benchmark-with-cassandra-stress">
<h2>Benchmark with cassandra-stress<a class="headerlink" href="#benchmark-with-cassandra-stress" title="Permalink to this headline">¶</a></h2>
<p>After deploying our cluster along with the monitoring, we can benchmark it using cassandra-stress and see its performance in Grafana. We have a mini cli that generates Kubernetes Jobs that run cassandra-stress against a cluster.</p>
<blockquote>
<div><p>Because cassandra-stress doesn’t scale well to multiple cores, we use multiple jobs with a small core count for each</p>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run a benchmark with 10 jobs, with 6 cpus and 50.000.000 operations each.</span>
<span class="c1"># Each Job will throttle throughput to 30.000 ops/sec for a total of 300.000 ops/sec.</span>
hack/cass-stress-gen.py --num-jobs<span class="o">=</span><span class="m">10</span> --cpu<span class="o">=</span><span class="m">6</span> --memory<span class="o">=</span>20G --ops<span class="o">=</span><span class="m">50000000</span> --limit<span class="o">=</span><span class="m">30000</span>
kubectl apply -f scripts/cassandra-stress.yaml
</pre></div>
</div>
<p>Make sure you set the proper arguments in case you have altered things such as <em>name</em> or <em>namespace</em>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./hack/cass-stress-gen.py -h
usage: cass-stress-gen.py <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>--num-jobs NUM_JOBS<span class="o">]</span> <span class="o">[</span>--name NAME<span class="o">]</span> <span class="o">[</span>--namespace NAMESPACE<span class="o">]</span> <span class="o">[</span>--scylla-version SCYLLA_VERSION<span class="o">]</span> <span class="o">[</span>--host HOST<span class="o">]</span> <span class="o">[</span>--cpu CPU<span class="o">]</span> <span class="o">[</span>--memory MEMORY<span class="o">]</span> <span class="o">[</span>--ops OPS<span class="o">]</span> <span class="o">[</span>--threads THREADS<span class="o">]</span> <span class="o">[</span>--limit LIMIT<span class="o">]</span>
                          <span class="o">[</span>--connections-per-host CONNECTIONS_PER_HOST<span class="o">]</span> <span class="o">[</span>--print-to-stdout<span class="o">]</span> <span class="o">[</span>--nodeselector NODESELECTOR<span class="o">]</span>

Generate cassandra-stress job templates <span class="k">for</span> Kubernetes.

optional arguments:
  -h, --help            show this <span class="nb">help</span> message and <span class="nb">exit</span>
  --num-jobs NUM_JOBS   number of Kubernetes <span class="nb">jobs</span> to generate - defaults to <span class="m">1</span>
  --name NAME           name of the generated yaml file - defaults to cassandra-stress
  --namespace NAMESPACE
                        namespace of the cassandra-stress <span class="nb">jobs</span> - defaults to <span class="s2">&quot;default&quot;</span>
  --scylla-version SCYLLA_VERSION
                        version of scylla server to use <span class="k">for</span> cassandra-stress - defaults to <span class="m">4</span>.0.0
  --host HOST           ip or dns name of host to connect to - defaults to scylla-cluster-client.scylla.svc
  --cpu CPU             number of cpus that will be used <span class="k">for</span> each job - defaults to <span class="m">1</span>
  --memory MEMORY       memory that will be used <span class="k">for</span> each job <span class="k">in</span> GB, ie 2G - defaults to 2G * cpu
  --ops OPS             number of operations <span class="k">for</span> each job - defaults to <span class="m">10000000</span>
  --threads THREADS     number of threads used <span class="k">for</span> each job - defaults to <span class="m">50</span> * cpu
  --limit LIMIT         rate limit <span class="k">for</span> each job - defaults to no rate-limiting
  --connections-per-host CONNECTIONS_PER_HOST
                        number of connections per host - defaults to number of cpus
  --print-to-stdout     print to stdout instead of writing to a file
  --nodeselector NODESELECTOR
                        nodeselector limits cassandra-stress pods to certain nodes. Use as a label selector, eg. --nodeselector <span class="nv">role</span><span class="o">=</span>scylla
</pre></div>
</div>
<p>While the benchmark is running, open up Grafana and take a look at the monitoring metrics.</p>
<p>After the Jobs finish, clean them up with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl delete -f scripts/cassandra-stress.yaml
</pre></div>
</div>
</div>
<div class="section" id="scale-down">
<h2>Scale Down<a class="headerlink" href="#scale-down" title="Permalink to this headline">¶</a></h2>
<p>The operator supports scale down of a rack. To make the changes, you can use:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla edit ScyllaCluster simple-cluster</span>
</pre></div>
</div>
<ul class="simple">
<li><p>To scale down a rack, change the <code class="docutils literal notranslate"><span class="pre">Spec.Members</span></code> field of the rack to the desired value.</p></li>
<li><p>After editing and saving the yaml, check your cluster’s Status and Events for information on what’s happening:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla describe ScyllaCluster simple-cluster</span>
</pre></div>
</div>
</div>
<div class="section" id="clean-up">
<h2>Clean Up<a class="headerlink" href="#clean-up" title="Permalink to this headline">¶</a></h2>
<p>To clean up all resources associated with this walk-through, you can run the commands below.</p>
<p><strong>NOTE:</strong> this will destroy your database and delete all of its associated data.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl delete -f examples/generic/cluster.yaml</span>
<span class="go">kubectl delete -f examples/common/operator.yaml</span>
<span class="go">kubectl delete -f examples/common/cert-manager.yaml</span>
</pre></div>
</div>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<p>If the cluster does not come up, the first step would be to examine the operator’s logs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla-operator logs deployment.apps/scylla-operator</span>
</pre></div>
</div>
<p>If everything looks OK in the operator logs, you can also look in the logs for one of the Scylla instances:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -n scylla logs simple-cluster-us-east-1-us-east-1a-0</span>
</pre></div>
</div>
</div>
</div>
  <div class="content-navigation">
  <div class="navigation navigation--prev">
    <a class="navigation__link" href="index.html">
      <button class="navigation__button">
        <i class="scylla-icon scylla-icon--chevron-left"></i>
      </button>
      <div class="navigation__title">
        <span class="colored">PREVIOUS</span> <br />Scylla Operator Documentation
      </div>
    </a>
  </div>
  <div class="navigation navigation--next">
    <a class="navigation__link" href="eks.html">
      <div class="navigation__title">
        <span class="colored">NEXT</span> <br />Deploying Scylla on EKS
      </div>
      <button class="navigation__button">
        <i class="scylla-icon scylla-icon--chevron-right"></i>
      </button>
    </a>
  </div>
</div> 
      </div>
      <div
        class="sidebar-left  large-order-1"
      > <div id="side-nav" class="side-nav custom-scroll-bar" data-closable data-toggler=".show">
  <button class="collapsible-button">
    <i class="scylla-icon scylla-icon--chevron-left"></i>
  </button>
  <div class="side-nav-content">
    <div class="side-nav__search">
      <div class="search-box">
        <ci-search></ci-search>
      </div>
    </div>
    <div class="side-nav__versions">
       <ul
  class="dropdown menu scylla-dropdown scylla-dropdown--versions "
  data-dropdown-menu
>
  <li class="scylla-dropdown__item">
    <a class="scylla-dropdown__title" href="#">
       v1.4 
      <i class="chevron scylla-icon scylla-icon--chevron-right"></i>
    </a>
    <ul class="menu scylla-dropdown__content"> 
      <li>
        <a href="generic.html"
          >v1.4</a
        >
      </li>
       
      <li>
        <a href="../v1.3/generic.html"
          >v1.3</a
        >
      </li>
       
      <li>
        <a href="../v1.2/generic.html"
          >v1.2</a
        >
      </li>
       
      <li>
        <a href="../v1.1/generic.html"
          >v1.1</a
        >
      </li>
       
      <li>
        <a href="../v1.0/generic.html"
          >v1.0</a
        >
      </li>
       
      <li>
        <a href="../v0.3/generic.html"
          >v0.3</a
        >
      </li>
       
      <li>
        <a href="../master/generic.html"
          >master</a
        >
      </li>
      
    </ul>
  </li>
</ul> 
    </div>
    <div class="side-nav__content">
      <ul class="current">
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Deploying Scylla on a Kubernetes Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="eks.html">Deploying Scylla on EKS</a></li>
<li class="toctree-l1"><a class="reference internal" href="gke.html">Deploying Scylla on GKE</a></li>
<li class="toctree-l1"><a class="reference internal" href="helm.html">Deploying Scylla stack using Helm Charts</a></li>
<li class="toctree-l1"><a class="reference internal" href="manager.html">Deploying Scylla Manager on a Kubernetes Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitoring.html">Setting up Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="node_operations.html">Node operations using Scylla Operator</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrade.html">Upgrade of Scylla Operator</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="known_issues.html">Known issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="scylla_cluster_crd.html">Scylla Cluster CRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to Scylla Operator</a></li>
</ul>

    </div>
  </div>
</div>
      </div>
      
      <div class="sidebar-right large-order-3">
         <div class="secondary-side-nav custom-scroll-bar">
  <div class="secondary-side-nav__content">
    <p class="topic-title">On this page</p>
    <ul>
<li><a class="reference internal" href="#">Deploying Scylla on a Kubernetes Cluster</a><ul>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#running-locally">Running locally</a></li>
<li><a class="reference internal" href="#deploy-cert-manager">Deploy Cert Manager</a></li>
<li><a class="reference internal" href="#deploy-scylla-operator">Deploy Scylla Operator</a></li>
<li><a class="reference internal" href="#create-and-initialize-a-scylla-cluster">Create and Initialize a Scylla Cluster</a><ul>
<li><a class="reference internal" href="#configure-host-networking">Configure host networking</a></li>
<li><a class="reference internal" href="#configure-container-kernel-parameters">Configure container kernel parameters</a></li>
<li><a class="reference internal" href="#deploying-alternator">Deploying Alternator</a></li>
</ul>
</li>
<li><a class="reference internal" href="#accessing-the-database">Accessing the Database</a></li>
<li><a class="reference internal" href="#configure-scylla">Configure Scylla</a></li>
<li><a class="reference internal" href="#configure-scylla-manager-agent">Configure Scylla Manager Agent</a><ul>
<li><a class="reference internal" href="#scylla-manager-agent-auth-token">Scylla Manager Agent auth token</a></li>
</ul>
</li>
<li><a class="reference internal" href="#set-up-monitoring">Set up monitoring</a></li>
<li><a class="reference internal" href="#scale-up">Scale Up</a></li>
<li><a class="reference internal" href="#benchmark-with-cassandra-stress">Benchmark with cassandra-stress</a></li>
<li><a class="reference internal" href="#scale-down">Scale Down</a></li>
<li><a class="reference internal" href="#clean-up">Clean Up</a></li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
</ul>

  </div>
</div> 
      </div>
    </section>

    <footer class="footer">
  <div class="footer-group">
    <div class="footer-top">
      <a class="footer-logo" href="https://www.scylladb.com"
        ><img
          src="_static/img/logo-scylla-horizontal-RGB.svg"
          alt="Logo"
      /></a>
      <div class="footer-links">
        <a class="footer-links__link" href="https://docs.scylladb.com/">Docs</a>
        <a
          class="footer-links__link"
          href="https://www.scylladb.com/company/contact-us/"
          >Contact Us</a
        >
        <a class="footer-links__link" href="https://www.scylladb.com/company/"
          >About Us</a
        >
      </div>
      <div class="footer-actions">
        <a
          class="footer-actions__link"
          href="https://groups.google.com/g/scylladb-users"
          target="_blank"
          ><span
            data-tooltip
            tabindex="1"
            title="User mailing list"
            data-position="bottom"
          >
            <img
              src="_static/img/icons/icon-mail-list.svg"
              alt="Mail List Icon"
            />
          </span>
        </a>
        <a
          class="footer-actions__link"
          href="http://slack.scylladb.com/"
          target="_blank"
          ><span
            data-tooltip
            tabindex="1"
            title="User Slack channel"
            data-position="bottom"
          >
            <img
              src="_static/img/icons/icon-slack.svg"
              alt="Slack Icon"
          /></span>
        </a>
      </div>
    </div>

    <div class="footer-bottom">
      <div class="footer-bottom__copyright"> &#169; 2022, ScyllaDB. All rights reserved.
      </div>
      <div class="footer-bottom__last-updated">
        Last updated on 08 January 2022.
      </div>
      <div class="footer-bottom__version">
        Powered by
        <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a> &amp;
        <a href="https://sphinx-theme.scylladb.com/"
          >ScyllaDB Theme 1.0.6</a
        >
      </div>
    </div>
  </div>
</footer>

    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-T8P2JP"
        height="0"
        width="0"
        style="display: none; visibility: hidden"
      ></iframe>
    </noscript>
  </body>
</html>